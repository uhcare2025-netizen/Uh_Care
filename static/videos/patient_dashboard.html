{% extends 'base.html' %}
{% load static humanize %}

{% block title %}Patient Dashboard - UH Care{% endblock %}

{% block extra_css %}
<style>
  :root {
    --uh-blue: #004a99;
    --uh-blue-dark: #002d6b;
    --uh-green: #009e4d;
    --uh-green-dark: #007a3d;
    --uh-red: #E60000;
    --uh-yellow: #f59e0b;
    --uh-blue-light: #e0f2ff;
    --uh-green-light: #e6fff0;
    --uh-yellow-light: #fffbeb;
    --light-bg: #f8fafc;
    --text-primary: #1f2937;
    --text-secondary: #6b7280;
    --border-color: #e5e7eb;
    --card-shadow: 0 1px 3px rgba(0, 0, 0, 0.07), 0 1px 2px rgba(0, 0, 0, 0.05);
    --card-shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.1);
  }

  body {
    background-color: var(--light-bg);
  }

  .dashboard-header {
    background: url('{% static "images/side-image.png" %}');
    background-size: cover;
    background-position: right center;
    background-attachment: fixed;
    color: white;
    padding: 2.5rem;
    border-radius: 12px;
    margin-bottom: 2rem;
    box-shadow: var(--card-shadow-lg);
    position: relative;
    overflow: hidden;
  }

  .dashboard-header h1 {
    font-size: 2.25rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    position: relative;
    z-index: 2;
  }

  .dashboard-header p {
    font-size: 1.1rem;
    opacity: 0.9;
    position: relative;
    z-index: 2;
  }

  .stat-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: var(--card-shadow);
    transition: all 0.3s ease;
    border-left: 5px solid var(--uh-blue);
  }

  .stat-card:hover {
    box-shadow: var(--card-shadow-lg);
    transform: translateY(-4px);
  }

  .stat-card.appointments {
    border-left-color: var(--uh-blue);
  }

  .stat-card.prescriptions {
    border-left-color: var(--uh-green);
  }

  .stat-card.balance {
    border-left-color: var(--uh-yellow);
  }

  .stat-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 3rem;
    height: 3rem;
    border-radius: 0.75rem;
    margin-bottom: 1rem;
  }

  .stat-icon.blue {
    background-color: var(--uh-blue-light);
    color: var(--uh-blue-dark);
  }

  .stat-icon.green {
    background-color: var(--uh-green-light);
    color: var(--uh-green-dark);
  }

  .stat-icon.amber {
    background-color: var(--uh-yellow-light);
    color: var(--uh-yellow);
  }

  .stat-label {
    font-size: 0.9rem;
    color: var(--text-secondary);
    font-weight: 600;
    margin-bottom: 0.5rem;
  }

  .stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
  }

  .stat-action {
    display: inline-block;
    margin-top: 0.5rem;
    font-size: 0.875rem;
    color: var(--uh-blue);
    text-decoration: none;
    font-weight: 600;
    transition: color 0.2s ease;
  }

  .stat-action:hover {
    color: var(--uh-blue-dark);
  }

  .section-title {
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
    margin-top: 2.5rem;
  }

  .section-subtitle {
    font-size: 1rem;
    color: var(--text-secondary);
    margin-bottom: 1.5rem;
  }

  .activity-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: var(--card-shadow);
    transition: all 0.3s ease;
  }

  .activity-card:hover {
    box-shadow: var(--card-shadow-lg);
  }

  .activity-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border-color);
  }

  .activity-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--text-primary);
  }

  .activity-view-all {
    font-size: 0.875rem;
    color: var(--uh-blue);
    text-decoration: none;
    font-weight: 600;
  }

  .activity-item {
    padding: 1rem 0;
    border-bottom: 1px solid #f9fafb;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
  }

  .activity-item:last-child {
    border-bottom: none;
  }

  .activity-info h4 {
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.25rem;
  }

  .activity-meta {
    font-size: 0.8rem;
    color: var(--text-secondary);
  }

  .activity-amount {
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--text-primary);
    text-align: right;
  }

  .empty-state {
    text-align: center;
    padding: 2rem;
    color: var(--text-secondary);
  }

  .empty-state svg {
    width: 3rem;
    height: 3rem;
    margin: 0 auto 1rem;
    opacity: 0.5;
  }

  .balance-card {
    background: linear-gradient(135deg, var(--uh-blue) 0%, var(--uh-blue-dark) 100%);
    color: white;
    border-radius: 12px;
    padding: 2rem 2.5rem;
    box-shadow: var(--card-shadow-lg);
    margin-bottom: 2rem;
    position: relative;
    overflow: hidden;
  }

  .balance-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1;
  }

  .balance-card video {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    min-width: 100%;
    min-height: 100%;
    width: auto;
    height: auto;
    z-index: 0;
    object-fit: cover;
  }

  .balance-card::after {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 200px;
    height: 200px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 50%;
    transform: translate(50%, -50%);
    z-index: 1;
  }

  .balance-content {
    position: relative;
    z-index: 1;
  }

  .balance-label {
    font-size: 0.9rem;
    font-weight: 600;
    opacity: 0.9;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .balance-amount {
    font-size: 2.75rem;
    font-weight: 700;
    margin: 1rem 0;
  }

  .balance-status {
    font-size: 1rem;
    opacity: 0.9;
    margin-bottom: 1.5rem;
  }

  .balance-actions {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .balance-btn {
    padding: 0.75rem 1.5rem;
    border-radius: 0.5rem;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.2s ease;
    font-size: 0.95rem;
    border: none;
    cursor: pointer;
  }

  .balance-btn-primary {
    background-color: white;
    color: var(--uh-blue-dark);
  }

  .balance-btn-primary:hover {
    background-color: #f0f4ff;
    transform: translateY(-2px);
  }

  .balance-btn-secondary {
    background-color: var(--uh-green);
    color: white;
  }

  .balance-btn-secondary:hover {
    background-color: var(--uh-green-dark);
    transform: translateY(-2px);
  }

  .quick-actions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2.5rem;
  }

  .action-btn {
    background: white;
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 1.25rem 1rem;
    text-align: center;
    text-decoration: none;
    color: var(--text-primary);
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: var(--card-shadow);
  }

  .action-btn:hover {
    border-color: var(--uh-blue);
    color: var(--uh-blue);
    box-shadow: var(--card-shadow-lg);
    transform: translateY(-4px);
  }

  .action-btn svg {
    width: 1.75rem;
    height: 1.75rem;
    margin: 0 auto 0.75rem;
    display: block;
    color: var(--uh-blue);
    transition: all 0.3s ease;
  }

  .action-btn:hover svg {
    transform: scale(1.1);
  }

  @media (max-width: 768px) {
    .dashboard-header h1 {
      font-size: 1.75rem;
    }

    .balance-amount {
      font-size: 2.25rem;
    }

    .quick-actions {
      grid-template-columns: 1fr;
    }

    .balance-actions {
      flex-direction: column;
    }

    .balance-btn {
      width: 100%;
      text-align: center;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
  
  <div class="dashboard-header">
    <h1>Welcome back, {{ user.first_name|default:user.username|default:'Patient' }}!</h1>
    <p>Manage your health services, appointments, and payments all in one place.</p>
  </div>

  <div class="quick-actions">
    <a href="{% url 'appointments:provider_directory' %}" class="action-btn">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
      </svg>
      Find Provider
    </a>
    <a href="{% url 'appointments:my_appointments' %}" class="action-btn">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0121 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
      </svg>
      Appointments
    </a>
    <a href="{% url 'pharmacy:my_orders' %}" class="action-btn">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      Pharmacy
    </a>
    <a href="{% url 'equipment:list' %}" class="action-btn">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5m6 4.125l2.25-2.25m0 0l2.25 2.25M12 21v-4.875m0 0H7.125M12 21H16.875" />
      </svg>
      Equipment
    </a>
  </div>

  <div class="balance-card">
    <video autoplay muted loop playsinline>
      <source src="{% static 'videos/Back-ground.mp4' %}" type="video/mp4">
      Your browser does not support the video tag.
    </video>
    <div class="balance-content">
      <div class="balance-label">üí≥ Current Account Balance</div>
      <div class="balance-amount">‡§∞‡•Å {{ stats.current_balance|default:0|floatformat:2|intcomma }}</div>
      <div class="balance-status">
        {% if stats.pending_payments and stats.pending_payments > 0 %}
          ‚ö†Ô∏è {{ stats.pending_payments|intcomma }} pending payment(s)
        {% else %}
          ‚úì All payments cleared
        {% endif %}
      </div>
      <div class="balance-actions">
        <a href="{% url 'dashboard:patient_balance' %}" class="balance-btn balance-btn-primary">View Details</a>
        <a href="{% url 'payments:history' %}?status=unpaid" class="balance-btn balance-btn-secondary">Pay Now</a>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <div class="stat-card appointments">
      <div class="stat-icon blue">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0121 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
        </svg>
      </div>
      <div class="stat-label">Upcoming Appointments</div>
      <div class="stat-value">{{ stats.total_appointments|default:0 }}</div>
      <a href="{% url 'appointments:my_appointments' %}" class="stat-action">View All ‚Üí</a>
    </div>

    <div class="stat-card prescriptions">
      <div class="stat-icon green">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      </div>
      <div class="stat-label">Active Prescriptions</div>
      <div class="stat-value">{{ stats.prescriptions_count|default:0 }}</div>
      <a href="{% url 'pharmacy:my_orders' %}" class="stat-action">View All ‚Üí</a>
    </div>

    <div class="stat-card balance">
      <div class="stat-icon amber">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      </div>
      <div class="stat-label">Outstanding Balance</div>
      <div class="stat-value">‡§∞‡•Å {{ stats.outstanding_amount|default:0|floatformat:2|intcomma }}</div>
      <a href="{% url 'dashboard:patient_balance' %}" class="stat-action">Details ‚Üí</a>
    </div>
  </div>

  <h2 class="section-title">Recent Activities</h2>
  <p class="section-subtitle">Your latest orders, equipment, and services</p>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <div class="activity-card">
      <div class="activity-header">
        <h3 class="activity-title">Pharmacy Orders</h3>
        <a href="{% url 'pharmacy:my_orders' %}" class="activity-view-all">View All</a>
      </div>
      <div>
        {% if recent_pharmacy_orders %}
          {% for order in recent_pharmacy_orders|slice:":3" %}
            <div class="activity-item">
              <div class="activity-info">
                <h4>Order #{{ order.order_number }}</h4>
                <span class="activity-meta">{{ order.created_at|date:'M d, Y' }} ‚Ä¢ {{ order.get_status_display }}</span>
              </div>
              <div class="activity-amount">‡§∞‡•Å {{ order.total_amount|intcomma }}</div>
            </div>
          {% endfor %}
        {% else %}
          <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
            </svg>
            <p>No pharmacy orders yet</p>
          </div>
        {% endif %}
      </div>
    </div>

    <div class="activity-card">
      <div class="activity-header">
        <h3 class="activity-title">Equipment</h3>
        <a href="{% url 'equipment:my_purchases' %}" class="activity-view-all">View All</a>
      </div>
      <div>
        {% if recent_purchases or recent_rentals %}
          {% for purchase in recent_purchases|slice:":2" %}
            <div class="activity-item">
              <div class="activity-info">
                <h4>{{ purchase.equipment.name }}</h4>
                <span class="activity-meta">{{ purchase.created_at|date:'M d, Y' }} ‚Ä¢ Qty: {{ purchase.quantity }}</span>
              </div>
              <div class="activity-amount">‡§∞‡•Å {{ purchase.total_amount|intcomma }}</div>
            </div>
          {% endfor %}
          {% for rental in recent_rentals|slice:":1" %}
            <div class="activity-item">
              <div class="activity-info">
                <h4>Rental: {{ rental.equipment.name }}</h4>
                <span class="activity-meta">{{ rental.created_at|date:'M d, Y' }}</span>
              </div>
              <div class="activity-amount">‡§∞‡•Å {{ rental.total_amount|intcomma }}</div>
            </div>
          {% endfor %}
        {% else %}
          <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 015.646 5.646 9 9 0 0120.354 15.354z" />
            </svg>
            <p>No equipment orders yet</p>
          </div>
        {% endif %}
      </div>
    </div>

    <div class="activity-card">
      <div class="activity-header">
        <h3 class="activity-title">Services Received</h3>
        <a href="{% url 'appointments:my_appointments' %}" class="activity-view-all">View All</a>
      </div>
      <div>
        {% if recent_appointments %}
          {% for appt in recent_appointments|slice:":3" %}
            <div class="activity-item">
              <div class="activity-info">
                <h4>{{ appt.service.name }}</h4>
                <span class="activity-meta">{{ appt.appointment_date|date:'M d, Y' }} ‚Ä¢ {{ appt.get_status_display }}</span>
              </div>
              <div class="activity-amount">‡§∞‡•Å {{ appt.total_amount|intcomma }}</div>
            </div>
          {% endfor %}
        {% else %}
          <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z" />
            </svg>
            <p>No services received yet</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

</div>
{% endblock %}
