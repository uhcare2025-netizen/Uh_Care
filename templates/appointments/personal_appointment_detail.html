{% extends 'base.html' %}
{% load static %}

{% block title %}Appointment #{{ appointment.id }}{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto py-8 sm:py-12 px-4 sm:px-6 lg:px-8">
    <!-- Page Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-uh-blue-700">Appointment Details</h1>
        <p class="text-lg text-gray-600 mt-2">Details for appointment #{{ appointment.id }}</p>
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

        <!-- Left Column: Provider Info -->
        <aside class="lg:col-span-1">
            <div class="bg-white rounded-lg shadow-xl p-6">
                <div class="flex items-center gap-4">
                    <!-- Provider Avatar (Logic from list page) -->
                    <div class="flex-shrink-0 w-20 h-20 rounded-full overflow-hidden bg-gray-100 flex items-center justify-center">
                        {% if appointment.provider.provider_profile and appointment.provider.provider_profile.avatar_url %}
                            <img src="{{ appointment.provider.provider_profile.avatar_url }}" alt="{{ appointment.provider.get_full_name }}" class="w-full h-full object-cover" />
                        {% elif appointment.provider.profile_image %}
                            <img src="{{ appointment.provider.profile_image }}" alt="{{ appointment.provider.get_full_name }}" class="w-full h-full object-cover" />
                        {% else %}
                            <span class="text-3xl font-bold text-uh-blue-600">{{ appointment.provider.first_name.0|upper }}</span>
                        {% endif %}
                    </div>
                    <!-- Provider Name & Specialization -->
                    <div class="min-w-0">
                        <h2 class="text-xl font-bold text-gray-900 truncate">{{ appointment.provider.get_full_name }}</h2>
                        {% if appointment.provider.provider_profile.specialization %}
                            <p class="text-sm text-gray-600">{{ appointment.provider.provider_profile.specialization }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </aside>

        <!-- Right Column: Appointment Details & Actions -->
        <main class="lg:col-span-2">
            <div class="bg-white rounded-lg shadow-xl overflow-hidden">

                <!-- Details Section -->
                <div class="p-6 sm:p-8">
                    <h3 class="text-xl font-semibold text-uh-blue-700 mb-6">Summary</h3>

                    <div class="space-y-5">
                        <!-- Status -->
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-medium text-gray-500">Status</span>
                            <span class="py-1 px-3 rounded-full text-xs font-semibold whitespace-nowrap
                                {% if appointment.status == 'pending' %} bg-yellow-100 text-yellow-800 
                                {% elif appointment.status == 'confirmed' %} bg-uh-blue-100 text-uh-blue-700
                                {% elif appointment.status == 'in_progress' %} bg-blue-100 text-blue-800
                                {% elif appointment.status == 'completed' %} bg-uh-green-100 text-uh-green-600
                                {% elif appointment.status == 'cancelled_by_patient' or appointment.status == 'cancelled_by_provider' or appointment.status == 'cancelled' %} bg-uh-red-100 text-uh-red-600
                                {% else %} bg-gray-100 text-gray-800 
                                {% endif %}">
                                {{ appointment.get_status_display|default:appointment.status }}
                            </span>
                        </div>

                        <!-- Appointment Type -->
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-medium text-gray-500">Appointment Type</span>
                            <span class="text-base font-semibold text-gray-800">{{ appointment.get_appointment_type_display }}</span>
                        </div>

                        <!-- Date -->
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-medium text-gray-500">Date</span>
                            <span class="text-base font-semibold text-gray-800">{{ appointment.appointment_date|date:"F d, Y" }}</span>
                        </div>

                        <!-- Patient Phone -->
                        {% if appointment.patient_phone %}
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-medium text-gray-500">Phone</span>
                            <span class="text-base font-semibold text-gray-800">{{ appointment.patient_phone }}</span>
                        </div>
                        {% endif %}

                        <!-- Time -->
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-medium text-gray-500">Time</span>
                            <span class="text-base font-semibold text-gray-800">{{ appointment.appointment_time|time:"g:i A" }} ({{ appointment.duration_minutes }} minutes)</span>
                        </div>

                        <!-- Location Type -->
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-medium text-gray-500">Location</span>
                            <span class="text-base font-semibold text-gray-800">{{ appointment.get_location_type_display }}</span>
                        </div>

                        <!-- Video link row (always shown for clarity) -->
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-medium text-gray-500">Video link</span>
                            <span class="text-base font-semibold text-uh-blue-700">
                                {% if appointment.video_link %}
                                    <a href="{{ appointment.video_link }}" target="_blank" rel="noopener noreferrer">Join meeting</a>
                                {% else %}
                                    {% if appointment.get_location_type_display == 'Video Call' %}
                                        <span class="text-sm text-gray-500">Not provided yet</span>
                                    {% else %}
                                        <span class="text-sm text-gray-400">N/A</span>
                                    {% endif %}
                                {% endif %}
                            </span>
                        </div>

                        <!-- Details grid: Reason, Symptoms, Patient Notes, Provider Notes, Diagnosis, Prescription -->
                        <div class="pt-5 border-t border-gray-200 grid grid-cols-1 gap-6">
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h4 class="text-sm font-medium text-gray-500 mb-2">Reason for Appointment</h4>
                                <p class="text-base text-gray-700">{{ appointment.reason|default:"Not provided" }}</p>
                            </div>

                            <div class="bg-gray-50 rounded-lg p-4">
                                <h4 class="text-sm font-medium text-gray-500 mb-2">Symptoms</h4>
                                <p class="text-base text-gray-700">{{ appointment.symptoms|default:"Not provided" }}</p>
                            </div>

                            <div class="bg-gray-50 rounded-lg p-4">
                                <h4 class="text-sm font-medium text-gray-500 mb-2">Patient Notes</h4>
                                <p class="text-base text-gray-700">{{ appointment.patient_notes|default:"None" }}</p>
                            </div>

                            <div class="bg-white rounded-lg p-4 shadow-sm">
                                <h4 class="text-sm font-medium text-gray-500 mb-2">Provider Notes</h4>
                                <p class="text-base text-gray-800">{{ appointment.provider_notes|default:"Not yet added by provider" }}</p>
                            </div>

                            <div class="bg-white rounded-lg p-4 shadow-sm">
                                <h4 class="text-sm font-medium text-gray-500 mb-2">Diagnosis</h4>
                                <p class="text-base text-gray-800">{{ appointment.diagnosis|default:"Not provided" }}</p>
                            </div>

                            <div class="bg-white rounded-lg p-4 shadow-sm">
                                <h4 class="text-sm font-medium text-gray-500 mb-2">Prescription</h4>
                                <p class="text-base text-gray-800">{{ appointment.prescription|default:"Not provided" }}</p>
                            </div>
                        </div>

                    </div>
                </div>
                
                <!-- Actions Section -->
                <div class="p-6 sm:p-8 bg-gray-50 border-t border-gray-200">
                    <h3 class="text-xl font-semibold text-uh-blue-700 mb-4">Actions</h3>
                    <div class="flex flex-col sm:flex-row items-center gap-4">
                        {% if appointment.can_review %}
                            <a href="{% url 'appointments:add_appointment_review' appointment.id %}" class="w-full sm:w-auto text-center bg-uh-blue-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-uh-blue-600 focus:outline-none focus:ring-2 focus:ring-uh-blue-700 focus:ring-offset-2 transition-all duration-200">
                                Leave a Review
                            </a>
                        {% endif %}

                        {% if appointment.can_cancel %}
                            <form method="post" action="{% url 'appointments:cancel_personal_appointment' appointment.id %}" class="w-full sm:w-auto">
                                {% csrf_token %}
                                <button type="submit" class="w-full text-center bg-uh-red-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-uh-red-500 focus:outline-none focus:ring-2 focus:ring-uh-red-600 focus:ring-offset-2 transition-all duration-200">
                                    Cancel Appointment
                                </button>
                            </form>
                        {% endif %}

                        {% if not appointment.can_review and not appointment.can_cancel %}
                        <p class="text-gray-600">No actions are available for this appointment.</p>
                        {% endif %}
                    </div>
                </div>

            </div>
        </main>

    </div>

</div>
{% endblock %}