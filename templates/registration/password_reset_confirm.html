{% extends "base.html" %}
{% load static %}

{% block title %}
    {% if validlink %}
        Set New Password - UH Care
    {% else %}
        Invalid Password Reset Link - UH Care
    {% endif %}
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<link rel="stylesheet" href="{% static 'css/auth.css' %}">
<style>
    .password-strength {
        margin-top: 0.75rem;
        height: 8px;
        background: #e0e0e0;
        border-radius: 4px;
        overflow: hidden;
    }

    .strength-meter {
        height: 100%;
        width: 0%;
        transition: width 0.3s, background-color 0.3s;
        background-color: #ccc;
    }

    .strength-meter.weak { width: 33%; background-color: #E60000; }
    .strength-meter.fair { width: 66%; background-color: #FF9500; }
    .strength-meter.strong { width: 100%; background-color: #009e4d; }

    .strength-text {
        font-size: 0.8rem;
        margin-top: 0.3rem;
        font-weight: 600;
    }

    .strength-text.weak { color: #E60000; }
    .strength-text.fair { color: #FF9500; }
    .strength-text.strong { color: #009e4d; }

    .password-requirements {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 8px;
        margin: 1rem 0;
        font-size: 0.9rem;
    }

    .requirement {
        display: flex;
        align-items: center;
        padding: 0.4rem 0;
        color: #636366;
    }

    .requirement i {
        width: 20px;
        text-align: center;
        margin-right: 0.6rem;
    }

    .requirement.met {
        color: #009e4d;
    }

    .requirement.met i { color: #009e4d; }
    .requirement.unmet i { color: #999; }
</style>
{% endblock %}

{% block content %}
<div class="auth-page">
    <div class="auth-page-bg">
        <video autoplay muted loop playsinline>
            <source src="{% static 'videos/Back-ground.mp4' %}" type="video/mp4">
        </video>
        <div class="auth-page-overlay"></div>
    </div>

    <div class="auth-container">
        <!-- SIDEBAR -->
        <div class="auth-sidebar">
            <div class="auth-sidebar-content">
                <img src="{% static 'images/side-image.png' %}" alt="UH Care" class="auth-sidebar-image">
                <h2>Create New Password</h2>
                <p>Secure your account with a strong, unique password</p>
                
                <div class="auth-sidebar-benefits">
                    <div class="auth-sidebar-benefit">
                        <i class="fas fa-lock"></i>
                        <span>Strong Encryption</span>
                    </div>
                    <div class="auth-sidebar-benefit">
                        <i class="fas fa-key"></i>
                        <span>Secure Access</span>
                    </div>
                    <div class="auth-sidebar-benefit">
                        <i class="fas fa-check-circle"></i>
                        <span>Real-time Validation</span>
                    </div>
                    <div class="auth-sidebar-benefit">
                        <i class="fas fa-shield-alt"></i>
                        <span>Enhanced Security</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- FORM SECTION -->
        <div class="auth-form-section">
            {% if validlink %}
                <div class="auth-form-header">
                    <h1><i class="fas fa-key"></i> Set New Password</h1>
                    <p>Create a strong password to secure your account</p>
                </div>

                {% if messages %}
                    <div>
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags|default:'info' }}">
                                {{ message }}
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}

                <form method="post" class="auth-form">
                    {% csrf_token %}

                    <!-- Password Requirements -->
                    <div class="password-requirements">
                        <strong><i class="fas fa-list"></i> Password Requirements:</strong>
                        <div class="requirement unmet" id="req-length">
                            <i class="fas fa-circle-check"></i>
                            At least 8 characters
                        </div>
                        <div class="requirement unmet" id="req-upper">
                            <i class="fas fa-circle-check"></i>
                            At least one uppercase letter (A-Z)
                        </div>
                        <div class="requirement unmet" id="req-lower">
                            <i class="fas fa-circle-check"></i>
                            At least one lowercase letter (a-z)
                        </div>
                        <div class="requirement unmet" id="req-number">
                            <i class="fas fa-circle-check"></i>
                            At least one number (0-9)
                        </div>
                        <div class="requirement unmet" id="req-special">
                            <i class="fas fa-circle-check"></i>
                            At least one special character (!@#$%^&*)
                        </div>
                    </div>

                    <!-- New Password Field -->
                    <div class="form-group {% if form.new_password1.errors %}has-error{% endif %}">
                        <label for="{{ form.new_password1.id_for_label }}">{{ form.new_password1.label }}</label>
                        {{ form.new_password1 }}
                        
                        <div class="password-strength" id="strength-container">
                            <div class="strength-meter" id="strength-meter"></div>
                        </div>
                        <div class="strength-text" id="strength-text">Password strength: Weak</div>

                        {% if form.new_password1.errors %}
                            <ul class="field-errors">
                                {% for error in form.new_password1.errors %}
                                    <li>{{ error }}</li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                    </div>

                    <!-- Confirm Password Field -->
                    <div class="form-group {% if form.new_password2.errors %}has-error{% endif %}">
                        <label for="{{ form.new_password2.id_for_label }}">{{ form.new_password2.label }}</label>
                        {{ form.new_password2 }}
                        
                        {% if form.new_password2.errors %}
                            <ul class="field-errors">
                                {% for error in form.new_password2.errors %}
                                    <li>{{ error }}</li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                    </div>

                    <!-- Non-field Errors -->
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {% for error in form.non_field_errors %}
                                <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}

                    <button type="submit" class="btn-auth btn-auth-primary">
                        <i class="fas fa-lock"></i> Update Password
                    </button>
                </form>

                <script>
                    const passwordInput = document.getElementById('id_new_password1');
                    const confirmInput = document.getElementById('id_new_password2');
                    const strengthMeter = document.getElementById('strength-meter');
                    const strengthText = document.getElementById('strength-text');
                    
                    const requirements = {
                        length: document.getElementById('req-length'),
                        upper: document.getElementById('req-upper'),
                        lower: document.getElementById('req-lower'),
                        number: document.getElementById('req-number'),
                        special: document.getElementById('req-special')
                    };

                    passwordInput.addEventListener('input', function() {
                        const password = this.value;
                        let strength = 0;

                        // Check length
                        if (password.length >= 8) {
                            strength++;
                            requirements.length.classList.add('met');
                            requirements.length.classList.remove('unmet');
                        } else {
                            requirements.length.classList.remove('met');
                            requirements.length.classList.add('unmet');
                        }

                        // Check uppercase
                        if (/[A-Z]/.test(password)) {
                            strength++;
                            requirements.upper.classList.add('met');
                            requirements.upper.classList.remove('unmet');
                        } else {
                            requirements.upper.classList.remove('met');
                            requirements.upper.classList.add('unmet');
                        }

                        // Check lowercase
                        if (/[a-z]/.test(password)) {
                            strength++;
                            requirements.lower.classList.add('met');
                            requirements.lower.classList.remove('unmet');
                        } else {
                            requirements.lower.classList.remove('met');
                            requirements.lower.classList.add('unmet');
                        }

                        // Check number
                        if (/[0-9]/.test(password)) {
                            strength++;
                            requirements.number.classList.add('met');
                            requirements.number.classList.remove('unmet');
                        } else {
                            requirements.number.classList.remove('met');
                            requirements.number.classList.add('unmet');
                        }

                        // Check special character
                        if (/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)) {
                            strength++;
                            requirements.special.classList.add('met');
                            requirements.special.classList.remove('unmet');
                        } else {
                            requirements.special.classList.remove('met');
                            requirements.special.classList.add('unmet');
                        }

                        // Update strength meter
                        let strengthLevel = 'weak';
                        if (strength >= 4) strengthLevel = 'strong';
                        else if (strength >= 3) strengthLevel = 'fair';

                        strengthMeter.className = 'strength-meter ' + strengthLevel;
                        
                        const strengthLabels = {
                            weak: 'Weak',
                            fair: 'Fair',
                            strong: 'Strong'
                        };
                        strengthText.textContent = 'Password strength: ' + strengthLabels[strengthLevel];
                        strengthText.className = 'strength-text ' + strengthLevel;
                    });
                </script>

            {% else %}
                <div class="auth-form-header">
                    <h1><i class="fas fa-exclamation-circle" style="color: #E60000;"></i> Invalid Link</h1>
                    <p>This password reset link is invalid or has expired</p>
                </div>

                <div class="alert alert-danger">
                    <strong>Link Expired or Invalid</strong>
                    <p>This password reset link has expired or is invalid. This can happen if:</p>
                    <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                        <li>The link has been used already</li>
                        <li>The link is more than 24 hours old</li>
                        <li>The link was tampered with</li>
                    </ul>
                </div>

                <a href="{% url 'password_reset' %}" class="btn-auth btn-auth-primary">
                    <i class="fas fa-envelope"></i> Request New Reset Link
                </a>

                <a href="{% url 'accounts:login' %}" class="btn-auth btn-auth-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Login
                </a>
            {% endif %}

            <div class="auth-links">
                <p>Remember your password? <a href="{% url 'accounts:login' %}">Back to Login</a></p>
            </div>
        </div>
    </div>
</div>
{% endblock %}
